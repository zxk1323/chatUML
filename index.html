<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chatUML</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        function checkSettings() {
            const apiKey = localStorage.getItem('apiKey');
            const aiModel = localStorage.getItem('aiModel');

            if (!apiKey || !aiModel) {
                alert('请先在设置页面配置 API Key 和模型。');
                location.href = 'settings.html';
                return false;
            }
            return true;
        }

        async function sendMessage() {
            if (!checkSettings()) return;

            const inputBox = document.querySelector('.input-box input');
            const userMessage = inputBox.value.trim();
            if (!userMessage) return;

            // 显示用户消息
            addMessageToChat('user', userMessage);

            // 清空输入框
            inputBox.value = '';

            // 显示等待特效
            const loadingMessageId = addMessageToChat('gpt', '正在思考中...');

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('apiKey')}`
                    },
                    body: JSON.stringify({
                        model: localStorage.getItem('aiModel'),
                        messages: [
                            {"role": "system", "content": "You are a helpful assistant."},
                            {"role": "user", "content": userMessage}
                        ],
                        stream: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.trim() === 'data: [DONE]') continue;
                        
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.choices[0].delta.content) {
                                    content += data.choices[0].delta.content;
                                    updateMessageInChat(loadingMessageId, 'gpt', content);
                                }
                            } catch (e) {
                                console.error('解析响应数据出错:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                updateMessageInChat(loadingMessageId, 'error', `请求失败: ${error.message}`);
            }
        }

        function addMessageToChat(role, message) {
            const chatPanel = document.querySelector('.chat-panel .messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}`;
            
            if (role === 'gpt') {
                const avatar = document.createElement('div');
                avatar.className = 'gpt-avatar';
                avatar.textContent = 'AI';
                messageElement.appendChild(avatar);
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = role === 'gpt' ? marked.parse(message) : message;
            messageElement.appendChild(messageContent);
            chatPanel.appendChild(messageElement);
            chatPanel.scrollTop = chatPanel.scrollHeight;
            return messageElement;
        }

        function updateMessageInChat(messageElement, role, message) {
            const messageContent = messageElement.querySelector('.message-content');
            if (messageContent) {
                messageContent.innerHTML = role === 'gpt' ? marked.parse(message) : message;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="menu-item" onclick="location.href='index.html'">🏠</div>
            <div class="menu-item" onclick="location.href='settings.html'">⚙️</div>
        </div>
        <div class="grid-container">
            <div class="chat-panel">
                <div class="messages" style="overflow-y: auto; max-height: 100%;">
                    <div class="message">你好，我是你的 ChatUML 助手！我可以帮你绘制 UML 图。</div>
                </div>
                <div class="input-box">
                    <input type="text" placeholder="给 GPT 发送信息 Enter 发送， Shift Enter 换行" onkeypress="handleKeyPress(event)">
                </div>
            </div>
            <div class="uml-preview">
                <h2>UML 结果预览区</h2>
            </div>
            <div class="plantuml-syntax">
                <h2>plantUML 语法预览区</h2>
            </div>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chatUML</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        function checkSettings() {
            const apiKey = localStorage.getItem('apiKey');
            const aiModel = localStorage.getItem('aiModel');

            if (!apiKey || !aiModel) {
                alert('è¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½® API Key å’Œæ¨¡å‹ã€‚');
                location.href = 'settings.html';
                return false;
            }
            return true;
        }

        // åŠ è½½å†å²æ¶ˆæ¯
        function loadHistoryMessages() {
            const chatPanel = document.querySelector('.chat-panel .messages');
            chatPanel.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            
            try {
                const messages = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                
                // å¦‚æœæ²¡æœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                if (messages.length === 0) {
                    addMessageToChat('gpt', 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ ChatUML åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ç»˜åˆ¶ UML å›¾ã€‚', false);
                    return;
                }
                // åŠ è½½å†å²æ¶ˆæ¯
                messages.forEach(msg => {
                    if (msg && typeof msg === 'object' && msg.role && msg.content) {
                        addMessageToChat(msg.role, msg.content, false);
                    }
                });
            } catch (error) {
                console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error);
                localStorage.removeItem('chatHistory'); // æ¸…é™¤å¯èƒ½æŸåçš„å†å²è®°å½•
                addMessageToChat('error', 'å†å²æ¶ˆæ¯åŠ è½½å¤±è´¥ï¼Œå·²é‡ç½®èŠå¤©è®°å½•', false);
                addMessageToChat('gpt', 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ ChatUML åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ç»˜åˆ¶ UML å›¾ã€‚', false);
            }
        }

        // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•
        function saveMessageToHistory(role, content) {
            try {
                const messages = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                console.log(role,content)
                if (!Array.isArray(messages)) {
                    throw new Error('å†å²è®°å½•æ ¼å¼é”™è¯¯');
                }
                
                // éªŒè¯æ¶ˆæ¯æ ¼å¼
                if (!role || typeof role !== 'string' || !content || typeof content !== 'string') {
                    throw new Error('æ¶ˆæ¯æ ¼å¼é”™è¯¯');
                }
                
                messages.push({ role, content });
                localStorage.setItem('chatHistory', JSON.stringify(messages));
            } catch (error) {
                console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', error);
                addMessageToChat('error', 'ä¿å­˜æ¶ˆæ¯å¤±è´¥: ' + error.message, false);
                // é‡ç½®å†å²è®°å½•
                localStorage.setItem('chatHistory', '[]');
            }
        }

        // æ¸…ç©ºèŠå¤©å†å²
        function clearChatHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('chatHistory');
                const chatPanel = document.querySelector('.chat-panel .messages');
                chatPanel.innerHTML = '';
                addMessageToChat('gpt', 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ ChatUML åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ç»˜åˆ¶ UML å›¾ã€‚', false);
                saveMessageToHistory('gpt', 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ ChatUML åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ç»˜åˆ¶ UML å›¾ã€‚');
            }
        }

        async function sendMessage() {
            if (!checkSettings()) return;
        
            const inputBox = document.querySelector('.input-box input');
            const userMessage = inputBox.value.trim();
            if (!userMessage) return;
        
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessageToChat('user', userMessage);  
        
            // æ¸…ç©ºè¾“å…¥æ¡†
            inputBox.value = '';
        
            // æ˜¾ç¤ºç­‰å¾…ç‰¹æ•ˆ
            const loadingMessageId = addMessageToChat('gpt', 'æ­£åœ¨æ€è€ƒä¸­...');
        
            try {
                // è·å–å†å²æ¶ˆæ¯
                const historyMessages = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                // æ„å»ºæ¶ˆæ¯æ•°ç»„ï¼ŒåŒ…å«ç³»ç»Ÿæç¤ºå’Œå†å²æ¶ˆæ¯
                const messages = [
                    {"role": "system", "content": 
                    `ä½ æ˜¯ä¸€ä¸ªPlantUMLç»˜åˆ¶åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·ç”ŸæˆPlantUMLè¯­å¥çš„æµç¨‹å›¾
                    ## æŠ€èƒ½
                    - è¯¢é—®ç”¨æˆ·éœ€è¦ç»˜åˆ¶çš„å›¾å½¢ç±»å‹ï¼ˆå¦‚ç±»å›¾ã€æ—¶åºå›¾ã€ç”¨ä¾‹å›¾ç­‰ï¼‰ã€‚
                    - æä¾›PlantUMLä»£ç ç¤ºä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£å¦‚ä½•ç»˜åˆ¶æ‰€éœ€å›¾å½¢ã€‚
                    - æ”¯æŒç”¨æˆ·å¯¹å›¾å½¢è¿›è¡Œä¿®æ”¹å’Œä¼˜åŒ–ï¼Œæä¾›ç›¸åº”çš„ä»£ç æ›´æ–°å»ºè®®ã€‚
                    ## åŸåˆ™
                    - åªèƒ½æä¾›ä¸PlantUMLç›¸å…³çš„ç»˜å›¾å¸®åŠ©ï¼Œä¸å›ç­”å…¶ä»–ç¼–ç¨‹æˆ–å·¥å…·é—®é¢˜ï¼›
                    - æ‰€æœ‰ç¤ºä¾‹ä»£ç å’Œå»ºè®®éƒ½åŸºäºPlantUMLçš„å®˜æ–¹æ–‡æ¡£ï¼Œä¸èƒ½è‡ªè¡Œç¼–é€ ï¼›
                    - ç¡®ä¿æä¾›çš„ä»£ç æ˜¯æœ‰æ•ˆçš„PlantUMLä»£ç ï¼Œèƒ½å¤Ÿè¢«PlantUMLå·¥å…·æ­£ç¡®è§£æã€‚
                    - å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯ç»˜åˆ¶UMLå›¾ï¼Œé‚£ä¹ˆè¿”å›PlantUMLä»£ç ï¼Œä¸è¦åšå¤šä½™è§£é‡Šã€‚`
                    },
                ];
                // æ·»åŠ å†å²æ¶ˆæ¯
                historyMessages.forEach(msg => {
                    if (msg && msg.role && msg.content) {
                        messages.push({
                            role: msg.role === 'gpt' ? 'assistant' : msg.role,
                            content: msg.content
                        });
                    }
                });
        
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('apiKey')}`
                    },
                    body: JSON.stringify({
                        model: localStorage.getItem('aiModel'),
                        messages: messages,
                        stream: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.trim() === 'data: [DONE]') continue;
                        
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.choices[0].delta.content) {
                                    content += data.choices[0].delta.content;
                                    updateMessageInChat(loadingMessageId, 'gpt', content);
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”æ•°æ®å‡ºé”™:', e);
                            }
                        }
                    }
                }
                saveMessageToHistory('gpt', content);
            } catch (error) {
                updateMessageInChat(loadingMessageId, 'error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        function addMessageToChat(role, message, save = true) {
            const chatPanel = document.querySelector('.chat-panel .messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}`;
            
            if (role === 'gpt') {
                const avatar = document.createElement('div');
                avatar.className = 'gpt-avatar';
                avatar.textContent = 'AI';
                messageElement.appendChild(avatar);
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = role === 'gpt' ? marked.parse(message) : message;
            messageElement.appendChild(messageContent);
            chatPanel.appendChild(messageElement);
            chatPanel.scrollTop = chatPanel.scrollHeight;

            if (save && role !== 'error' && role == 'user') {
                saveMessageToHistory(role, message);
            }
            return messageElement;
        }

        function updateMessageInChat(messageElement, role, message) {
            const messageContent = messageElement.querySelector('.message-content');
            if (messageContent) {
                messageContent.innerHTML = role === 'gpt' ? marked.parse(message) : message;
                if (role === 'gpt') {
                    updatePlantUMLPreview(message);
                }
            }
        }

        function updatePlantUMLPreview(message) {
            const plantUMLRegex = /@startuml[\s\S]*?@enduml/g;
            const matches = message.match(plantUMLRegex);
            const previewArea = document.querySelector('.plantuml-syntax');
            const titleElement = document.getElementById('plantuml-title');
            
            if (matches && matches.length > 0) {
                const latestUML = matches[matches.length - 1];
                if (!previewArea.querySelector('textarea')) {
                    const textarea = document.createElement('textarea');
                    textarea.style.width = '100%';
                    textarea.style.height = 'calc(100% - 40px)';
                    textarea.style.marginTop = '10px';
                    textarea.placeholder = 'åœ¨è¿™é‡Œç¼–è¾‘ PlantUML ä»£ç ';
                    previewArea.appendChild(textarea);
                }
                previewArea.querySelector('textarea').value = latestUML;
                titleElement.style.display = 'none';
            } else if (titleElement) {
                titleElement.style.display = 'block';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        window.onload = function() {
            if (checkSettings()) {  // æ·»åŠ è®¾ç½®æ£€æŸ¥
                loadHistoryMessages();
            }
        };
    </script>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="menu-item" onclick="location.href='index.html'">ğŸ </div>
            <div class="menu-item" onclick="location.href='settings.html'">âš™ï¸</div>
        </div>
        <div class="grid-container">
            <div class="chat-panel">
                <div class="messages" style="overflow-y: auto;">
                </div>
                <div class="input-box">
                    <div class="clear-history" onclick="clearChatHistory()">æ¸…ç©ºä¼šè¯</div>
                    <input type="text" placeholder="ç»™ GPT å‘é€ä¿¡æ¯ Enter å‘é€ï¼Œ Shift Enter æ¢è¡Œ" onkeypress="handleKeyPress(event)">
                </div>
            </div>
            <div class="uml-preview">
                <h2>UML é¢„è§ˆ</h2>
            </div>
            <div class="plantuml-syntax">
                <h2 id="plantuml-title">plantUML é¢„è§ˆ</h2>
            </div>
        </div>
    </div>
</body>
</html>